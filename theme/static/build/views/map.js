define(["backbone","underscore","text!templates/map.html","async!googlemaps"],function(e,t,a){var n="/static/lib/images/marker.png",o=new google.maps.Geocoder;app.markers=[],center=new google.maps.LatLng(12.9141417,74.85595680000006);var p=function(e,t){return new google.maps.Marker({map:app.map,draggable:!0,position:e,title:t,icon:n})};setMap=function(e){clearMarkers(),app.markers.push(p(e)),app.map.setCenter(e||center)},clearMarkers=function(){app.markers.forEach(function(e){e.setMap(null)}),app.markers=[]},setAddress=function(e,t){o.geocode({address:e},function(e,a){if(a==google.maps.GeocoderStatus.OK){var n=e[0].geometry.location.lat(),o=e[0].geometry.location.lng(),p=new google.maps.LatLng(n,o);t&&t(p)}else t&&t()})};var r=function(e){return{zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP,center:e,mapTypeControl:!1,streetViewControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP}}};return e.View.extend({template:t.template(a),initialize:function(){app.events.centerChanged=new Event,this.render(),app.events.centerChanged.listeners.push(t.bind(this.refreshMap,this))},refreshMap:function(){var e=app.map.getCenter();e&&$.ajax({url:"/api/cities/get_nearest_city/",method:"GET",data:{latitude:e.K,longitude:e.G},success:function(e){e&&app.collections.city.add(e),app.views.home.citySelect.val(e.id)}})},render:function(){this.html=$(this.template({})),this.$el.html(this.html),this.renderMap()},renderMap:function(){app.map=new google.maps.Map(document.getElementById("map-canvas"),r()),app.map.addListener("bounds_changed",function(){app.searchBox.setBounds(app.map.getBounds())}),app.map.addListener("center_changed",function(){var e=arguments,t=this;app.events.centerChanged.listeners.forEach(function(a){a&&a.apply(t,e)})}),app.promises.mapLoaded.resolve()}})});